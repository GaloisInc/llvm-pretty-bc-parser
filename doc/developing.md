# Developers' documentation

<!-- markdown-toc start - Don't edit this section. Run M-x markdown-toc-refresh-toc -->
**Table of Contents**

- [Developers' documentation](#developers-documentation)
    - [Upstream documentation](#upstream-documentation)
    - [Running the tests](#running-the-tests)
        - [`llvm-disasm-test`](#llvm-disasm-test)
            - [description](#description)
            - [use](#use)
        - [`regression-test`](#regression-test)
        - [`unit-test`](#unit-test)
    - [Travis CI build](#travis-ci-build)

<!-- markdown-toc end -->

## Upstream documentation

Official (yet incomplete) reference: https://llvm.org/docs/BitCodeFormat.html

C++ implementation:
 + Parser:
   * [Release 4.0](https://github.com/llvm-mirror/llvm/blob/release_40/lib/Bitcode/Reader/BitcodeReader.cpp)
   * [Release 5.0](https://github.com/llvm-mirror/llvm/blob/release_50/lib/Bitcode/Reader/BitcodeReader.cpp)
   * [Release 6.0](https://github.com/llvm-mirror/llvm/blob/release_60/lib/Bitcode/Reader/BitcodeReader.cpp)
 + Record codes:
   * Bitstream format:
     - [Release 4.0](https://github.com/llvm-mirror/llvm/blob/release_40/include/llvm/Bitcode/BitCodes.h)
     - [Release 5.0](https://github.com/llvm-mirror/llvm/blob/release_50/include/llvm/Bitcode/BitCodes.h)
     - [Release 6.0](https://github.com/llvm-mirror/llvm/blob/release_60/include/llvm/Bitcode/BitCodes.h)
   * LLVM bitcode:
     - [Release 4.0](https://github.com/llvm-mirror/llvm/blob/release_40/include/llvm/Bitcode/LLVMBitCodes.h)
     - [Release 5.0](https://github.com/llvm-mirror/llvm/blob/release_50/include/llvm/Bitcode/LLVMBitCodes.h)
     - [Release 6.0](https://github.com/llvm-mirror/llvm/blob/release_60/include/llvm/Bitcode/LLVMBitCodes.h)

## Running the tests

### `llvm-disasm-test`

#### description

This test compares the behavior of `llvm-disasm` against that of `llvm-dis`, by
having them both disassemble the same file and diffing their output (in general,
we don't expect them to exactly match).

Additionally, by default this test does a "round-trip" comparison of
`llvm-disasm` against itself. After disassembling the first time, it reassembles
the output of `llvm-disasm` and runs it again. It then compares both the
ASTs and the LLVM assembly generated by the first and second run of
`llvm-disasm`, to ensure that the printer/parser combo is idempotent.

#### use

To compare the behavior of `llvm-disasm` against that of `llvm-dis`:
```bash
cabal build
./dist/build/disasm-test/disasm-test ./disasm-test/tests/fun-attrs.ll

# When using cabal new-build, the binary locations aren't so nice.
$(find . -name disasm-test -type f) disasm-test/tests/*.ll
```
To see all the options,
```bash
./dist/build/disasm-test/disasm-test --help
```

If you have [Nix](https://nixos.org/nix/) installed, you can easily compare
against multiple versions of `llvm-dis`, e.g.
```bash
nix-shell --pure -p llvm_6 --run "./dist/build/disasm-test/disasm-test ./disasm-test/tests/fun-attrs.ll"
```

### `regression-test`

To compare the behavior of two different versions of `llvm-disasm`, run
```bash
cabal build
./dist/build/regression-test/regression-test --rev1=HEAD --rev2=HEAD~1
```
To see all the options,
```bash
./dist/build/regression-test/regression-test --help
```

### `unit-test`

These are run with `cabal test` or `cabal new-test`.

## Travis CI build

**Note**: the CI build doesn't run the full test suite, just some regression
tests and the unit tests.

The `.travis.yml` file is generated using
[haskell-ci](https://github.com/haskell-CI/haskell-ci). However, we add the 
following:
```yml
  - git clone https://github.com/elliottt/llvm-pretty llvm-pretty
  - "printf 'packages: \".\" llvm-pretty/\\n' > cabal.project"
```
and:
```yml
  - git clone https://github.com/elliottt/llvm-pretty llvm-pretty
  - "printf 'packages: llvm-pretty-bc-parser-*/*.cabal llvm-pretty/*.cabal\\n' > cabal.project"
```
so that it picks up the latest `llvm-pretty`.


When Cabal [supports fetching tarballs](https://github.com/haskell/cabal/issues/2189), 
we can use the following so that it fetches the latest `llvm-pretty` from Github.
```yml
  - "printf 'packages: llvm-pretty-bc-parser-*/*.cabal https://github.com/elliottt/llvm-pretty/archive/master.tar.gz \\n' > cabal.project"
```
